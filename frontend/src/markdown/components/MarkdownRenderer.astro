---
import { markdownService } from "../services/markdown.service";
import { ImageLightboxController } from "./ImageLightboxController";
import "@/markdown/styles/markdown.css";

interface Props {
  content: string;
}

const { content } = Astro.props;

// Render Markdown to HTML
const htmlContent = await markdownService.render(content);
---

<div class="markdown-content" set:html={htmlContent} />

<!-- shadcn Dialog-based Lightbox -->
<ImageLightboxController client:only="react" />

<script>
  // Image click handler - communicates with React lightbox
  document.addEventListener("DOMContentLoaded", () => {
    document
      .querySelectorAll(".markdown-image[data-zoomable]")
      .forEach((img) => {
        img.addEventListener("click", () => {
          // Dispatch custom event for React component
          const event = new CustomEvent("openImageLightbox", {
            detail: {
              src: (img as HTMLImageElement).src,
              alt: (img as HTMLImageElement).alt,
            },
          });
          window.dispatchEvent(event);
        });
      });
  });

  // Copy button functionality for code blocks
  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll("pre code[data-code]").forEach((block) => {
      const pre = block.parentElement;
      if (!pre) return;

      // Create copy button
      const button = document.createElement("button");
      button.className = "copy-button";
      button.innerHTML = `
        <svg class="copy-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
          <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
        </svg>
        <span class="copy-text">Copy</span>
      `;

      // Wrap pre in container
      const container = document.createElement("div");
      container.className = "code-block-container";
      pre.parentNode?.insertBefore(container, pre);
      container.appendChild(pre);

      // Add language label
      const lang = block.getAttribute("data-lang") || "text";
      const langLabel = document.createElement("div");
      langLabel.className = "code-block-header";
      langLabel.innerHTML = `
        <span class="code-lang">${lang}</span>
      `;
      langLabel.appendChild(button);
      container.insertBefore(langLabel, pre);

      // Copy functionality
      button.addEventListener("click", async () => {
        const code = decodeURIComponent(block.getAttribute("data-code") || "");

        try {
          await navigator.clipboard.writeText(code);
          button.classList.add("copied");
          const text = button.querySelector(".copy-text");
          if (text) text.textContent = "Copied!";

          setTimeout(() => {
            button.classList.remove("copied");
            if (text) text.textContent = "Copy";
          }, 2000);
        } catch (err) {
          console.error("Failed to copy:", err);
        }
      });
    });
  });
</script>
