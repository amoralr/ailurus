---
import type { Heading } from "@/markdown/services/markdown.service";

interface Props {
  headings: Heading[];
}

const { headings } = Astro.props;

// Filter headings to show only h2 and h3
const filteredHeadings = headings.filter((h) => h.level === 2 || h.level === 3);
---

{
  filteredHeadings.length > 0 && (
    <aside class="toc" id="toc">
      <div class="toc-content">
        <h4 class="toc-title">En esta p√°gina</h4>
        <nav class="toc-nav">
          <ul class="toc-list">
            {filteredHeadings.map((heading) => (
              <li class={`toc-item toc-level-${heading.level}`}>
                <a href={`#${heading.id}`} class="toc-link">
                  {heading.text}
                </a>
              </li>
            ))}
          </ul>
        </nav>
        <button class="back-to-top" id="back-to-top" aria-label="Volver arriba">
          <svg
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <path d="M12 19V5M5 12l7-7 7 7" />
          </svg>
          <span>Volver arriba</span>
        </button>
      </div>
    </aside>
  )
}

<script>
  // Scroll spy for TOC
  function initTOC() {
    const tocLinks = document.querySelectorAll(".toc-link");
    const headings = document.querySelectorAll(
      ".markdown-content h2, .markdown-content h3"
    );

    if (!tocLinks.length || !headings.length) return;

    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          const id = entry.target.getAttribute("id");
          // Find link by comparing href attribute directly (safer than querySelector with IDs)
          const tocLink = Array.from(tocLinks).find(
            (link) => link.getAttribute("href") === `#${id}`
          );

          if (entry.isIntersecting) {
            // Remove active from all
            tocLinks.forEach((link) => link.classList.remove("active"));
            // Add active to current
            tocLink?.classList.add("active");
          }
        });
      },
      {
        rootMargin: "-100px 0px -80% 0px",
        threshold: 0,
      }
    );

    headings.forEach((heading) => {
      observer.observe(heading);
    });

    // Smooth scroll
    tocLinks.forEach((link) => {
      link.addEventListener("click", (e) => {
        e.preventDefault();
        const href = link.getAttribute("href");
        if (!href) return;

        // Extract ID from href and use getElementById for safe selection
        const id = href.substring(1); // Remove the '#'
        const target = document.getElementById(id);

        if (target) {
          const offset = 80; // Header height
          const targetPosition =
            target.getBoundingClientRect().top + window.pageYOffset - offset;

          window.scrollTo({
            top: targetPosition,
            behavior: "smooth",
          });

          // Update URL
          history.pushState(null, "", href);
        }
      });
    });

    // Back to top button
    const backToTop = document.getElementById("back-to-top");
    if (backToTop) {
      backToTop.addEventListener("click", () => {
        window.scrollTo({
          top: 0,
          behavior: "smooth",
        });
      });

      // Show/hide based on scroll
      window.addEventListener("scroll", () => {
        if (window.scrollY > 300) {
          backToTop.classList.add("visible");
        } else {
          backToTop.classList.remove("visible");
        }
      });
    }
  }

  // Initialize on load and on page navigation
  document.addEventListener("DOMContentLoaded", initTOC);
  document.addEventListener("astro:page-load", initTOC);
</script>

<style>
  .toc {
    width: 250px;
    height: 100vh;
    position: sticky;
    top: 0;
    overflow-y: auto;
    padding: 2rem 1rem;
    border-left: 1px solid hsl(var(--border));
  }

  .toc-content {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .toc-title {
    font-size: 0.875rem;
    font-weight: 600;
    color: hsl(var(--foreground));
    margin: 0;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid hsl(var(--border));
  }

  .toc-nav {
    flex: 1;
  }

  .toc-list {
    list-style: none;
    margin: 0;
    padding: 0;
  }

  .toc-item {
    margin: 0;
  }

  .toc-link {
    display: block;
    padding: 0.375rem 0;
    color: hsl(var(--muted-foreground));
    text-decoration: none;
    font-size: 0.8125rem;
    line-height: 1.5;
    transition: all 0.2s;
    border-left: 2px solid transparent;
    padding-left: 0.75rem;
    margin-left: -0.75rem;
  }

  .toc-link:hover {
    color: hsl(var(--foreground));
  }

  .toc-link.active {
    color: hsl(var(--primary));
    border-left-color: hsl(var(--primary));
    font-weight: 500;
  }

  .toc-level-2 {
    padding-left: 0;
  }

  .toc-level-3 {
    padding-left: 1rem;
  }

  .toc-level-3 .toc-link {
    font-size: 0.75rem;
  }

  .back-to-top {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0.75rem;
    margin-top: 1rem;
    font-size: 0.875rem;
    color: hsl(var(--muted-foreground));
    background: hsl(var(--secondary));
    border: 1px solid hsl(var(--border));
    border-radius: 0.375rem;
    cursor: pointer;
    transition: all 0.2s;
    opacity: 0;
    pointer-events: none;
  }

  .back-to-top.visible {
    opacity: 1;
    pointer-events: auto;
  }

  .back-to-top:hover {
    color: hsl(var(--foreground));
    background: hsl(var(--background));
    border-color: hsl(var(--primary));
  }

  .back-to-top svg {
    width: 16px;
    height: 16px;
  }

  /* Custom scrollbar */
  .toc {
    scrollbar-width: thin;
    scrollbar-color: hsl(var(--border)) transparent;
  }

  .toc::-webkit-scrollbar {
    width: 6px;
  }

  .toc::-webkit-scrollbar-track {
    background: transparent;
  }

  .toc::-webkit-scrollbar-thumb {
    background: hsl(var(--border));
    border-radius: 3px;
  }

  .toc::-webkit-scrollbar-thumb:hover {
    background: hsl(var(--muted-foreground));
  }

  /* Responsive */
  @media (max-width: 1440px) {
    .toc {
      display: none;
    }
  }
</style>
